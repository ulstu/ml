
from neo4j import GraphDatabase
import random

# Подключение к базе данных Neo4j
class Neo4jDB:
    def __init__(self, uri, user, password):
        self.driver = GraphDatabase.driver(uri, auth=(user, password))

    def close(self):
        self.driver.close()

    def setup_ontology_and_rules(self, rules):
        with self.driver.session() as session:
            # Удаление всех существующих данных (для примера)
            session.run("MATCH (n) DETACH DELETE n")

            # Создание онтологии предметной области и добавление правил
            for rule in rules:
                condition_name = rule["condition"]
                action_name = rule["action"]

                # Создание узлов для правил, условий и действий
                session.run("""
                MERGE (condition:Condition {name: $condition_name})
                MERGE (action:Action {name: $action_name})
                CREATE (rule:Rule {name: $rule_name, max_speed: $max_speed})
                MERGE (rule)-[:HAS_CONDITION]->(condition)
                MERGE (rule)-[:REQUIRES_ACTION]->(action)
                """, condition_name=condition_name, action_name=action_name,
                     rule_name=rule["name"], max_speed=rule.get("max_speed"))

    def fetch_applicable_rules(self, sensor_data):
        """ Извлекает правила, которые соответствуют текущим показаниям датчиков """
        with self.driver.session() as session:
            applicable_rules = []
            for key, value in sensor_data.items():
                query = """
                MATCH (rule:Rule)-[:HAS_CONDITION]->(condition:Condition {name: $condition_name})
                MATCH (rule)-[:REQUIRES_ACTION]->(action:Action)
                RETURN rule.name AS rule_name, rule.max_speed AS max_speed,
                       condition.name AS condition, action.name AS action
                """
                results = session.run(query, condition_name=value)
                for record in results:
                    applicable_rules.append({
                        "name": record["rule_name"],
                        "condition": record["condition"],
                        "action": record["action"],
                        "max_speed": record["max_speed"]
                    })
            return applicable_rules

# Создание правил
rules = [
    # Дополнительные правила для погодных условий
    {"name": "Остановка при грозе", "condition": "Гроза", "action": "Остановка"},
    {"name": "Уменьшение скорости при боковом ветре", "condition": "Боковой ветер", "action": "Замедление", "max_speed": 5},
    {"name": "Снижение расхода при повышенной влажности", "condition": "Повышенная влажность", "action": "Уменьшение расхода"},
    {"name": "Остановка при очень низкой видимости", "condition": "Низкая видимость", "action": "Остановка"},
    {"name": "Снижение скорости при мокром снеге", "condition": "Мокрый снег", "action": "Замедление", "max_speed": 5},

    # Увеличение эффективности при разных условиях рельефа
    {"name": "Поддержание постоянной скорости на равнине", "condition": "Равнина", "action": "Ускорение", "max_speed": 20},
    {"name": "Автоматическое увеличение расхода на склонах", "condition": "Склон", "action": "Увеличение расхода"},
    {"name": "Снижение расхода на низинных участках", "condition": "Низина", "action": "Уменьшение расхода"},
    {"name": "Автоматическое отключение на затопленных участках", "condition": "Затопленный участок", "action": "Отключение сектора"},
    {"name": "Уменьшение зоны опрыскивания на узких участках", "condition": "Узкий участок", "action": "Сужение зоны опрыскивания"},

    # Правила для защиты от загрязнения почвы и воды
    {"name": "Отключение секторов при пересечении речек", "condition": "Река", "action": "Отключение сектора"},
    {"name": "Снижение скорости на прибрежных зонах", "condition": "Прибрежная зона", "action": "Замедление", "max_speed": 5},
    {"name": "Уменьшение расхода при высоких температурах", "condition": "Высокая температура", "action": "Уменьшение расхода"},
    {"name": "Отключение секторов вблизи скважин", "condition": "Скважина", "action": "Отключение сектора"},
    {"name": "Приостановка работы при обнаружении эрозионной зоны", "condition": "Эрозионная зона", "action": "Остановка"},

    # Особенности работы на сложных участках
    {"name": "Замедление при наличии ям", "condition": "Ямы", "action": "Замедление", "max_speed": 5},
    {"name": "Сужение зоны опрыскивания на крутых склонах", "condition": "Крутой склон", "action": "Сужение зоны опрыскивания"},
    {"name": "Отключение опрыскивания на гравийных склонах", "condition": "Гравийный склон", "action": "Отключение сектора"},
    {"name": "Снижение расхода на каменистых участках", "condition": "Каменистый участок", "action": "Уменьшение расхода"},
    {"name": "Увеличение ширины зоны опрыскивания на ровных участках", "condition": "Ровный участок", "action": "Расширение зоны опрыскивания"},

    # Поддержание скорости и безопасности вблизи препятствий
    {"name": "Остановка при обнаружении большой техники", "condition": "Большая техника", "action": "Остановка"},
    {"name": "Замедление при обнаружении небольшой техники", "condition": "Небольшая техника", "action": "Замедление", "max_speed": 5},
    {"name": "Снижение расхода вблизи заборов", "condition": "Забор", "action": "Уменьшение расхода"},
    {"name": "Остановка при обнаружении скал", "condition": "Скала", "action": "Остановка"},
    {"name": "Снижение скорости при пересечении каналов", "condition": "Канал", "action": "Замедление", "max_speed": 5},

    # Работа на узких участках
    {"name": "Отключение крайних секций на узких дорогах", "condition": "Узкая дорога", "action": "Отключение крайних секторов"},
    {"name": "Сужение зоны обработки на узких полях", "condition": "Узкое поле", "action": "Сужение зоны опрыскивания"},
    {"name": "Автоматическое отключение на периметре узких участков", "condition": "Периметр узкого участка", "action": "Отключение сектора"},
    {"name": "Снижение расхода на суженных полях", "condition": "Суженное поле", "action": "Уменьшение расхода"},
    {"name": "Точное опрыскивание на небольших участках", "condition": "Небольшой участок", "action": "Точное опрыскивание"},

    # Дополнительные правила для ночного времени
    {"name": "Автоматическое включение светодиодного освещения ночью", "condition": "Ночное время", "action": "Включение светодиодов"},
    {"name": "Ограничение скорости ночью", "condition": "Ночное время", "action": "Замедление", "max_speed": 8},
    {"name": "Отключение секций при отсутствии освещения", "condition": "Отсутствие освещения", "action": "Отключение сектора"},
    {"name": "Точное опрыскивание в зоне с ограниченной видимостью ночью", "condition": "Ограниченная видимость ночью", "action": "Точное опрыскивание"},
    {"name": "Остановка при обнаружении пешехода ночью", "condition": "Пешеход ночью", "action": "Остановка"},

    # Защита от повреждений и предотвращение загрязнения
    {"name": "Снижение скорости на участках с песком", "condition": "Песчаный участок", "action": "Замедление", "max_speed": 10},
    {"name": "Отключение секторов на болотах", "condition": "Болото", "action": "Отключение сектора"},
    {"name": "Сужение зоны опрыскивания в зонах с мелким камнем", "condition": "Мелкий камень", "action": "Сужение зоны опрыскивания"},
    {"name": "Приостановка работы при температуре ниже 0°С", "condition": "Температура ниже нуля", "action": "Остановка"},
    {"name": "Снижение скорости при подвижных грунтах", "condition": "Подвижный грунт", "action": "Замедление", "max_speed": 5},

    # Регулировка для разного типа почв
    {"name": "Увеличение расхода на тяжелых почвах", "condition": "Тяжелая почва", "action": "Увеличение расхода"},
    {"name": "Снижение расхода на легких почвах", "condition": "Легкая почва", "action": "Уменьшение расхода"},
    {"name": "Отключение секторов на участках с редкими растениями", "condition": "Редкие растения", "action": "Отключение сектора"},
    {"name": "Оптимизация расхода на участках с густыми кустарниками", "condition": "Густой кустарник", "action": "Увеличение расхода"},
    {"name": "Увеличение точности на почвах с высокой впитываемостью", "condition": "Высокая впитываемость почвы", "action": "Точное опрыскивание"},

    # Работа на границе участков
    {"name": "Автоматическое отключение при пересечении границ", "condition": "Граница участка", "action": "Отключение сектора"},
    {"name": "Снижение скорости при приближении к границам участка", "condition": "Близость к границе участка", "action": "Замедление", "max_speed": 5},
    {"name": "Регулирование зоны обработки в зоне границы", "condition": "Зона границы", "action": "Регулирование зоны опрыскивания"},
    {"name": "Снижение расхода на периметре участка", "condition": "Периметр участка", "action": "Уменьшение расхода"},
    {"name": "Приостановка работы при пересечении границы соседнего участка", "condition": "Соседний участок", "action": "Остановка"},

    # Дополнительные правила для предотвращения повреждения почвы
    {"name": "Снижение давления на участках с мягкой почвой", "condition": "Мягкая почва", "action": "Снижение давления"},
    {"name": "Остановка при обнаружении рыхлого грунта", "condition": "Рыхлый грунт", "action": "Остановка"},
    {"name": "Уменьшение расхода на участках с засухой", "condition": "Засуха", "action": "Уменьшение расхода"},
    {"name": "Приостановка работы при повышенной эрозии почвы", "condition": "Повышенная эрозия почвы", "action": "Остановка"},
    {"name": "Автоматическое отключение секторов при чрезмерном увлажнении", "condition": "Чрезмерное увлажнение", "action": "Отключение сектора"},

    # Автоматическое регулирование для повышения эффективности
    {"name": "Автоматическое регулирование скорости в зависимости от типа растений", "condition": "Разные растения", "action": "Регулирование скорости"},
    {"name": "Оптимизация зоны опрыскивания на участках с молодыми растениями", "condition": "Молодые растения", "action": "Сужение зоны опрыскивания"},
    {"name": "Увеличение ширины обработки на ровной местности", "condition": "Ровная местность", "action": "Расширение зоны опрыскивания"},
    {"name": "Приостановка работы на участках с остатками растительности", "condition": "Остатки растительности", "action": "Остановка"},
    {"name": "Снижение скорости для более точного опрыскивания на суженных участках", "condition": "Суженный участок", "action": "Замедление", "max_speed": 5},

    # Ограничения скорости на разных типах покрытия
    {"name": "Максимальная скорость на ровной дороге", "condition": "Ровная дорога", "action": "Ускорение", "max_speed": 30},
    {"name": "Максимальная скорость на гравийной дороге", "condition": "Гравийная дорога", "action": "Ускорение", "max_speed": 20},
    {"name": "Максимальная скорость на мокрой дороге", "condition": "Мокрая дорога", "action": "Ускорение", "max_speed": 15},
    {"name": "Снижение скорости на поворотах", "condition": "Резкий поворот", "action": "Замедление", "max_speed": 10},
    {"name": "Максимальная скорость при обработке поля", "condition": "Поле", "action": "Ускорение", "max_speed": 15},
    # Погодные условия и безопасность
    {"name": "Торможение при слабом дожде", "condition": "Слабый дождь", "action": "Торможение"},
    {"name": "Остановка при сильном дожде", "condition": "Сильный дождь", "action": "Остановка"},
    {"name": "Замедление при тумане", "condition": "Туман", "action": "Замедление", "max_speed": 8},
    {"name": "Приостановка опрыскивания при сильном ветре", "condition": "Сильный ветер", "action": "Остановка"},
    {"name": "Продолжение работы при ясной погоде", "condition": "Ясная погода", "action": "Ускорение", "max_speed": 30},
    # Условия для работы на полях, связанные с цифровой картой
    {"name": "Отключение секции при входе на обработанную площадь", "condition": "Обработанная зона", "action": "Отключение сектора"},
    {"name": "Полное отключение всех секций при входе на полностью обработанную площадь", "condition": "Полностью обработанная зона", "action": "Отключение всех секторов"},
    {"name": "Включение секций при входе на необработанную площадь", "condition": "Необработанная зона", "action": "Включение сектора"},
    {"name": "Остановка при пересечении границы поля", "condition": "Граница поля", "action": "Остановка"},
    {"name": "Ограничение обработки по цифровой карте", "condition": "Зона вне карты", "action": "Отключение всех секторов"},
    # Условия для безопасного обнаружения препятствий
    {"name": "Торможение перед препятствием", "condition": "Препятствие на расстоянии 10 метров", "action": "Торможение"},
    {"name": "Остановка перед человеком на пути", "condition": "Человек в радиусе 10 метров", "action": "Остановка"},
    {"name": "Торможение перед животными", "condition": "Животное в радиусе 10 метров", "action": "Торможение"},
    {"name": "Поддержание безопасного расстояния до другой техники", "condition": "Техника в радиусе 5 метров", "action": "Замедление"},
    {"name": "Остановка при обнаружении здания", "condition": "Здание в радиусе 5 метров", "action": "Остановка"},
    # Условия для улучшения эффективности опрыскивания
    {"name": "Оптимальная скорость на ровной почве", "condition": "Ровная почва", "action": "Ускорение", "max_speed": 25},
    {"name": "Снижение скорости при высоком уклоне", "condition": "Крутой склон", "action": "Замедление", "max_speed": 10},
    {"name": "Увеличение ширины обработки на ровной поверхности", "condition": "Ровная поверхность", "action": "Расширение зоны опрыскивания"},
    {"name": "Сужение зоны опрыскивания на холмах", "condition": "Холм", "action": "Сужение зоны опрыскивания"},
    {"name": "Приостановка опрыскивания при сбое навигации", "condition": "Сбой навигации", "action": "Остановка"},
    # Условия для точного опрыскивания по цифровой карте
    {"name": "Отключение опрыскивателя при обработке границ участка", "condition": "Граница участка", "action": "Отключение сектора"},
    {"name": "Ручное управление для сложных участков", "condition": "Сложный рельеф", "action": "Ручное управление"},
    {"name": "Оптимизация расхода при подходе к границе", "condition": "Пограничная зона", "action": "Уменьшение расхода"},
    {"name": "Снижение расхода жидкости при сильном ветре", "condition": "Сильный ветер", "action": "Уменьшение расхода"},
    {"name": "Приостановка опрыскивания в зоне отдыха", "condition": "Зона отдыха", "action": "Отключение всех секторов"},
    # Применение зонального опрыскивания
    {"name": "Автоматическое отключение при наличии водоемов", "condition": "Водоем в радиусе 5 метров", "action": "Отключение сектора"},
    {"name": "Активизация точечного опрыскивания на небольших участках", "condition": "Небольшой участок", "action": "Включение точечного опрыскивания"},
    {"name": "Отключение секторов на необрабатываемых участках", "condition": "Необрабатываемый участок", "action": "Отключение сектора"},
    {"name": "Автоматическое включение при входе в зону обработки", "condition": "Зона обработки", "action": "Включение сектора"},
    {"name": "Переключение на более высокий расход при обработке густых культур", "condition": "Густые культуры", "action": "Увеличение расхода"},
    # Правила для предотвращения загрязнения окружающей среды
    {"name": "Запрет обработки вблизи населенных пунктов", "condition": "Населенный пункт в радиусе 100 метров", "action": "Отключение всех секторов"},
    {"name": "Уменьшение расхода вблизи водоемов", "condition": "Водоем в радиусе 10 метров", "action": "Уменьшение расхода"},
    {"name": "Снижение скорости для предотвращения загрязнения", "condition": "Пыльная дорога", "action": "Замедление", "max_speed": 10},
    {"name": "Запрет обработки при встречном ветре", "condition": "Встречный ветер", "action": "Остановка"},
    {"name": "Отключение секторов на пастбищах", "condition": "Пастбище", "action": "Отключение сектора"},
    # Условия для работы ночью
    {"name": "Снижение скорости ночью", "condition": "Ночное время", "action": "Замедление", "max_speed": 10},
    {"name": "Автоматическое включение световых индикаторов", "condition": "Ночное время", "action": "Включение световых индикаторов"},
    {"name": "Увеличение расстояния обнаружения препятствий ночью", "condition": "Ночное время", "action": "Увеличение радиуса обнаружения"},
    {"name": "Запрет работы на склонах ночью", "condition": "Крутой склон ночью", "action": "Остановка"},
    {"name": "Повышение точности обработки ночью", "condition": "Ночное время", "action": "Точное опрыскивание"},
    # Условия для экономии ресурсов
    {"name": "Снижение расхода жидкости в малонасыщенных культурах", "condition": "Малонасыщенные культуры", "action": "Уменьшение расхода"},
    {"name": "Отключение секторов на малопродуктивных участках", "condition": "Малопродуктивный участок", "action": "Отключение сектора"},
    {"name": "Переключение на экономичный режим на ровных участках", "condition": "Ровный участок", "action": "Экономичный режим"},
    {"name": "Увеличение расхода в труднопроходимых местах", "condition": "Труднопроходимое место", "action": "Увеличение расхода"},
    {"name": "Остановка при превышении допустимой нагрузки", "condition": "Превышение нагрузки", "action": "Остановка"},
    # Увеличение ширины обработки на открытых участках
    {"name": "Увеличение ширины обработки на открытых участках", "condition": "Открытый участок", "action": "Расширение зоны опрыскивания"},
    {"name": "Отключение секторов в углах поля", "condition": "Углы поля", "action": "Отключение сектора"},
    {"name": "Сужение зоны опрыскивания вблизи дороги", "condition": "Вблизи дороги", "action": "Сужение зоны опрыскивания"},
    {"name": "Автоматическое приостановление работы при обнаружении животных", "condition": "Животное на поле", "action": "Остановка"},
    {"name": "Регулирование расхода в зависимости от типа культуры", "condition": "Разные культуры", "action": "Регулирование расхода"},

    # Ограничения скорости на разных типах покрытия
    {"name": "Максимальная скорость на ровной дороге", "condition": "Ровная дорога", "action": "Ускорение", "max_speed": 30},
    {"name": "Максимальная скорость на гравийной дороге", "condition": "Гравийная дорога", "action": "Ускорение", "max_speed": 20},
    {"name": "Максимальная скорость на мокрой дороге", "condition": "Мокрая дорога", "action": "Ускорение", "max_speed": 15},
    {"name": "Снижение скорости на поворотах", "condition": "Резкий поворот", "action": "Замедление", "max_speed": 10},
    {"name": "Максимальная скорость при обработке поля", "condition": "Поле", "action": "Ускорение", "max_speed": 15},
    # Погодные условия и безопасность
    {"name": "Торможение при слабом дожде", "condition": "Слабый дождь", "action": "Торможение"},
    {"name": "Остановка при сильном дожде", "condition": "Сильный дождь", "action": "Остановка"},
    {"name": "Замедление при тумане", "condition": "Туман", "action": "Замедление", "max_speed": 8},
    {"name": "Приостановка опрыскивания при сильном ветре", "condition": "Сильный ветер", "action": "Остановка"},
    {"name": "Продолжение работы при ясной погоде", "condition": "Ясная погода", "action": "Ускорение", "max_speed": 30},
    # Условия для работы на полях, связанные с цифровой картой
    {"name": "Отключение секции при входе на обработанную площадь", "condition": "Обработанная зона", "action": "Отключение сектора"},
    {"name": "Полное отключение всех секций при входе на полностью обработанную площадь", "condition": "Полностью обработанная зона", "action": "Отключение всех секторов"},
    {"name": "Включение секций при входе на необработанную площадь", "condition": "Необработанная зона", "action": "Включение сектора"},
    {"name": "Остановка при пересечении границы поля", "condition": "Граница поля", "action": "Остановка"},
    {"name": "Ограничение обработки по цифровой карте", "condition": "Зона вне карты", "action": "Отключение всех секторов"},
    # Условия для безопасного обнаружения препятствий
    {"name": "Торможение перед препятствием", "condition": "Препятствие на расстоянии 10 метров", "action": "Торможение"},
    {"name": "Остановка перед человеком на пути", "condition": "Человек в радиусе 10 метров", "action": "Остановка"},
    {"name": "Торможение перед животными", "condition": "Животное в радиусе 10 метров", "action": "Торможение"},
    {"name": "Поддержание безопасного расстояния до другой техники", "condition": "Техника в радиусе 5 метров", "action": "Замедление"},
    {"name": "Остановка при обнаружении здания", "condition": "Здание в радиусе 5 метров", "action": "Остановка"},
    # Условия для улучшения эффективности опрыскивания
    {"name": "Оптимальная скорость на ровной почве", "condition": "Ровная почва", "action": "Ускорение", "max_speed": 25},
    {"name": "Снижение скорости при высоком уклоне", "condition": "Крутой склон", "action": "Замедление", "max_speed": 10},
    {"name": "Увеличение ширины обработки на ровной поверхности", "condition": "Ровная поверхность", "action": "Расширение зоны опрыскивания"},
    {"name": "Сужение зоны опрыскивания на холмах", "condition": "Холм", "action": "Сужение зоны опрыскивания"},
    {"name": "Приостановка опрыскивания при сбое навигации", "condition": "Сбой навигации", "action": "Остановка"},
    # Условия для точного опрыскивания по цифровой карте
    {"name": "Отключение опрыскивателя при обработке границ участка", "condition": "Граница участка", "action": "Отключение сектора"},
    {"name": "Ручное управление для сложных участков", "condition": "Сложный рельеф", "action": "Ручное управление"},
    {"name": "Оптимизация расхода при подходе к границе", "condition": "Пограничная зона", "action": "Уменьшение расхода"},
    {"name": "Снижение расхода жидкости при сильном ветре", "condition": "Сильный ветер", "action": "Уменьшение расхода"},
    {"name": "Приостановка опрыскивания в зоне отдыха", "condition": "Зона отдыха", "action": "Отключение всех секторов"},
    # Применение зонального опрыскивания
    {"name": "Автоматическое отключение при наличии водоемов", "condition": "Водоем в радиусе 5 метров", "action": "Отключение сектора"},
    {"name": "Активизация точечного опрыскивания на небольших участках", "condition": "Небольшой участок", "action": "Включение точечного опрыскивания"},
    {"name": "Отключение секторов на необрабатываемых участках", "condition": "Необрабатываемый участок", "action": "Отключение сектора"},
    {"name": "Автоматическое включение при входе в зону обработки", "condition": "Зона обработки", "action": "Включение сектора"},
    {"name": "Переключение на более высокий расход при обработке густых культур", "condition": "Густые культуры", "action": "Увеличение расхода"},
    # Правила для предотвращения загрязнения окружающей среды
    {"name": "Запрет обработки вблизи населенных пунктов", "condition": "Населенный пункт в радиусе 100 метров", "action": "Отключение всех секторов"},
    {"name": "Уменьшение расхода вблизи водоемов", "condition": "Водоем в радиусе 10 метров", "action": "Уменьшение расхода"},
    {"name": "Снижение скорости для предотвращения загрязнения", "condition": "Пыльная дорога", "action": "Замедление", "max_speed": 10},
    {"name": "Запрет обработки при встречном ветре", "condition": "Встречный ветер", "action": "Остановка"},
    {"name": "Отключение секторов на пастбищах", "condition": "Пастбище", "action": "Отключение сектора"},
    # Условия для работы ночью
    {"name": "Снижение скорости ночью", "condition": "Ночное время", "action": "Замедление", "max_speed": 10},
    {"name": "Автоматическое включение световых индикаторов", "condition": "Ночное время", "action": "Включение световых индикаторов"},
    {"name": "Увеличение расстояния обнаружения препятствий ночью", "condition": "Ночное время", "action": "Увеличение радиуса обнаружения"},
    {"name": "Запрет работы на склонах ночью", "condition": "Крутой склон ночью", "action": "Остановка"},
    {"name": "Повышение точности обработки ночью", "condition": "Ночное время", "action": "Точное опрыскивание"},
    # Условия для экономии ресурсов
    {"name": "Снижение расхода жидкости в малонасыщенных культурах", "condition": "Малонасыщенные культуры", "action": "Уменьшение расхода"},
    {"name": "Отключение секторов на малопродуктивных участках", "condition": "Малопродуктивный участок", "action": "Отключение сектора"},
    {"name": "Переключение на экономичный режим на ровных участках", "condition": "Ровный участок", "action": "Экономичный режим"},
    {"name": "Увеличение расхода в труднопроходимых местах", "condition": "Труднопроходимое место", "action": "Увеличение расхода"},
    {"name": "Остановка при превышении допустимой нагрузки", "condition": "Превышение нагрузки", "action": "Остановка"},
    # Увеличение ширины обработки на открытых участках
    {"name": "Увеличение ширины обработки на открытых участках", "condition": "Открытый участок", "action": "Расширение зоны опрыскивания"},
    {"name": "Отключение секторов в углах поля", "condition": "Углы поля", "action": "Отключение сектора"},
    {"name": "Сужение зоны опрыскивания вблизи дороги", "condition": "Вблизи дороги", "action": "Сужение зоны опрыскивания"},
    {"name": "Автоматическое приостановление работы при обнаружении животных", "condition": "Животное на поле", "action": "Остановка"},
    {"name": "Регулирование расхода в зависимости от типа культуры", "condition": "Разные культуры", "action": "Регулирование расхода"}
]

# Инициализация и настройка базы данных Neo4j
db = Neo4jDB("bolt://localhost:7687", "neo4j", "treugolnik")
# db.setup_ontology_and_rules(rules)

# 2. Симуляция данных от датчиков
def generate_sensor_data():
    sensor_data = {
        "road_type": random.choice(["Ровная дорога", "Гравийная дорога"]),
        "weather": random.choice(["Гроза", "Боковой ветер", "Повышенная влажность", "Мокрый снег", "Ясная погода"]),
        "location": random.choice(["Обработанная зона", "Необработанная зона", "Узкий участок"]),
        "obstacle_distance": random.randint(0, 100)  # в метрах до препятствия
    }
    return sensor_data

# 3. Машина логического вывода
class RuleEngine:
    def __init__(self, db):
        self.db = db

    def execute_action(self, action, rule):
        """ Выполняет действие на основе правила """
        if action == "Ускорение":
            print(f"Действие: {action} - Максимальная скорость: {rule.get('max_speed', 'Не указано')} км/ч")
        elif action == "Остановка":
            print("Действие: Остановка")
        elif action == "Замедление":
            print(f"Действие: Замедление - Максимальная скорость: {rule.get('max_speed', 'Не указано')} км/ч")
        elif action == "Отключение сектора":
            print("Действие: Отключение сектора")
        elif action == "Уменьшение расхода":
            print("Действие: Уменьшение расхода")
        elif action == "Сужение зоны опрыскивания":
            print("Действие: Сужение зоны опрыскивания")
        elif action == "Увеличение расхода":
            print("Действие: Увеличение расхода")
        else:
            print(f"Действие: {action}")

    def process_rules(self, sensor_data):
        """ Извлекает правила динамически и выполняет действия при выполнении условий """
        applicable_rules = self.db.fetch_applicable_rules(sensor_data)
        if not applicable_rules:
            print("Нет применимых правил для текущих условий.")
            return

        for rule in applicable_rules:
            print(f"Правило '{rule['name']}' сработало.")
            self.execute_action(rule["action"], rule)

# 4. Основная функция для симуляции
def run_simulation(db):
    # Инициализируем двигатель правил, который будет динамически извлекать правила из Neo4j
    engine = RuleEngine(db)
    for a in range(5):
        # Генерируем данные датчиков
        sensor_data = generate_sensor_data()
        print("Текущие показания датчиков:", sensor_data)
        # Запускаем обработку правил
        engine.process_rules(sensor_data)
        print('---------------------------')

# Запуск симуляции
run_simulation(db)

# Закрытие соединения с базой данных
db.close()
